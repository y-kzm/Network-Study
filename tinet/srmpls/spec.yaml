# http://www.asciiflow.com

preinit:
  - cmds:
    - cmd: modprobe mpls_router
    - cmd: modprobe mpls_gso
    - cmd: modprobe mpls_iptunnel

nodes:
  - name: R1
    image: slankdev/frr
    interfaces:
    - { name: net0, type: direct, args: R2#net0 }
    - { name: net1, type: direct, args: R4#net0 }
  - name: R2
    image: slankdev/frr
    interfaces:
    - { name: net0, type: direct, args: R1#net0 }
    - { name: net1, type: direct, args: R3#net0 }
    - { name: net2, type: direct, args: R4#net2 }
  - name: R3
    image: slankdev/frr
    interfaces:
    - { name: net0, type: direct, args: R2#net1 }
    - { name: net1, type: direct, args: R4#net1 }
  - name: R4
    image: slankdev/frr
    interfaces:
    - { name: net0, type: direct, args: R1#net1 }
    - { name: net1, type: direct, args: R3#net1 }
    - { name: net2, type: direct, args: R2#net2 }

node_configs:
  - name: R1
    cmds:
      - cmd: /usr/lib/frr/frr start
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      # 使用可能なLabelの最大値を定義
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.1/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.1/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.9/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'router ospf'
          -c ' ospf router-id 10.255.0.1'
          -c ' router-info area 0.0.0.0'
          -c ' passive-interface lo'
          -c ' capability opaque'
          -c ' mpls-te on'
          -c ' mpls-te router-address 10.255.0.1'
          -c ' segment-routing on'
          -c ' segment-routing global-block 16000 19999'
          -c ' segment-routing node-msd 8'
          -c ' segment-routing prefix 10.255.0.1/32 index 1001'
          -c 'exit'
      # passive-interface lo 
      #   > passive-interfaceコマンドを使うと、RIPの送信やOSPFのHelloパケット送信を停止出来る．
      # capability opaque 
      #   > Opaque LSAのサポートを有効に．
      # 各ルータが使用可能なグローバルに意味のあるSID(Node SIDやPrefix SID等)の範囲をSRGB(Segment Routing Global Block)と呼ぶ．
      # Prefix SIDの20301をAbsolute Value、SRGBの先頭のSIDからの差分である4301をIndexと呼ぶ．

  - name: R2
    cmds:
      - cmd: /usr/lib/frr/frr start
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.conf.net2.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.2/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.2/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.5/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net2'
          -c ' ip address 10.0.0.13/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'router ospf'
          -c ' ospf router-id 10.255.0.2'
          -c ' router-info area 0.0.0.0'
          -c ' passive-interface lo'
          -c ' capability opaque'
          -c ' mpls-te on'
          -c ' mpls-te router-address 10.255.0.2'
          -c ' segment-routing on'
          -c ' segment-routing global-block 16000 19999'
          -c ' segment-routing node-msd 8'
          -c ' segment-routing prefix 10.255.0.2/32 index 1002'
          -c 'exit'

  - name: R3
    cmds:
      - cmd: /usr/lib/frr/frr start
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.3/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.6/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.17/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'router ospf'
          -c ' ospf router-id 10.255.0.3'
          -c ' router-info area 0.0.0.0'
          -c ' passive-interface lo'
          -c ' capability opaque'
          -c ' mpls-te on'
          -c ' mpls-te router-address 10.255.0.3'
          -c ' segment-routing on'
          -c ' segment-routing global-block 16000 19999'
          -c ' segment-routing node-msd 8'
          -c ' segment-routing prefix 10.255.0.3/32 index 1003'
          -c 'exit'

  - name: R4
    cmds:
      - cmd: /usr/lib/frr/frr start
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.conf.net2.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.4/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.10/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.18/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net2'
          -c ' ip address 10.0.0.14/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'router ospf'
          -c ' ospf router-id 10.255.0.4'
          -c ' router-info area 0.0.0.0'
          -c ' passive-interface lo'
          -c ' capability opaque'
          -c ' mpls-te on'
          -c ' mpls-te router-address 10.255.0.4'
          -c ' segment-routing on'
          -c ' segment-routing global-block 16000 19999'
          -c ' segment-routing node-msd 8'
          -c ' segment-routing prefix 10.255.0.4/32 index 1004'
          -c 'exit'

test:
  - name: pcap
    cmds:
      - cmd: echo "Start Pcap!"
      - cmd: docker exec R2 tcpdump -nni net0 -w /tmp/R2_net0.pcap -W1 -G90 & 
      - cmd: docker exec R2 tcpdump -nni net1 -w /tmp/R2_net1.pcap -W1 -G90 & 
      - cmd: docker exec R2 tcpdump -nni net2 -w /tmp/R2_net2.pcap -W1 -G90 & 
      - cmd: docker exec R4 tcpdump -nni net0 -w /tmp/R4_net0.pcap -W1 -G90 & 
      - cmd: docker exec R4 tcpdump -nni net1 -w /tmp/R4_net1.pcap -W1 -G90 & 
      - cmd: docker exec R4 tcpdump -nni net2 -w /tmp/R4_net2.pcap -W1 -G90 & 
  - name: operate
    cmds:
      ## Basic P2P-Link's Test
      # - cmd: docker exec R1 ping -c2 10.0.0.2
      # - cmd: docker exec R1 ping -c2 10.0.0.10
      # - cmd: docker exec R2 ping -c2 10.0.0.1
      # - cmd: docker exec R2 ping -c2 10.0.0.6
      # - cmd: docker exec R2 ping -c2 10.0.0.14
      # - cmd: docker exec R3 ping -c2 10.0.0.5
      # - cmd: docker exec R3 ping -c2 10.0.0.18
      # - cmd: docker exec R4 ping -c2 10.0.0.9
      # - cmd: docker exec R4 ping -c2 10.0.0.17
      # - cmd: docker exec R4 ping -c2 10.0.0.13
      ## Basic Routing Test
      # - cmd: docker exec R1 ping -c2 10.255.0.2
      # - cmd: docker exec R1 ping -c2 10.255.0.3
      # - cmd: docker exec R1 ping -c2 10.255.0.4
      # - cmd: docker exec R2 ping -c2 10.255.0.1
      # - cmd: docker exec R2 ping -c2 10.255.0.3
      # - cmd: docker exec R2 ping -c2 10.255.0.4
      # - cmd: docker exec R3 ping -c2 10.255.0.1
      # - cmd: docker exec R3 ping -c2 10.255.0.2
      # - cmd: docker exec R3 ping -c2 10.255.0.4
      # - cmd: docker exec R4 ping -c2 10.255.0.1
      # - cmd: docker exec R4 ping -c2 10.255.0.2
      # - cmd: docker exec R4 ping -c2 10.255.0.3
      ## SR-MPLS Operation
      - cmd: docker exec R1 ip route add 10.255.0.3/32 encap mpls 17004/17003 via 10.0.0.2
      - cmd: docker exec R3 ip route add 10.255.0.1/32 encap mpls 17002/17001 via 10.0.0.18
      ## SR-MPLS Test
      - cmd: docker exec R1 ping -c2 10.255.0.3 -I 10.255.0.1


